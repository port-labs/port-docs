name: Check for YAML File Changes

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-diff:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Set up Git for creating branches and PRs
    - name: Set up Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    # Download the YAML file from the URL
    - name: Download YAML file
      run: curl -sL https://api.getport.io/yaml -o new_file.yaml

    # Compare the downloaded file with the existing file in the repository
    - name: Check for differences
      id: diff_check
      run: |
        if diff new_file.yaml path/to/current_file.yaml > diff_output.txt; then
          echo "No changes detected."
          exit 0
        else
          echo "Differences detected!"
        fi

    # Create a new branch with the date if differences are found
    - name: Create new branch
      if: steps.diff_check.outcome == 'failure'
      run: |
        branch_name="update-yaml-$(date +'%Y-%m-%d')"
        git checkout -b "$branch_name"
        cp new_file.yaml path/to/current_file.yaml
        git add path/to/current_file.yaml
        git commit -m "Update YAML file on $(date +'%Y-%m-%d')"
        git push origin "$branch_name"

    # Create a Pull Request if differences are found
    - name: Create Pull Request
      if: steps.diff_check.outcome == 'failure'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Update YAML file on $(date +'%Y-%m-%d')"
        branch: "update-yaml-$(date +'%Y-%m-%d')"  # The branch created
        title: "Update YAML file on $(date +'%Y-%m-%d')"
        body: "This PR updates the YAML file from the URL https://api.getport.io/yaml. Please review the changes."
