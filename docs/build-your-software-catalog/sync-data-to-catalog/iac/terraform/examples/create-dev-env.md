---
sidebar_position: 2
title: Create a Developer Environment
description: Provision a developer environment and reflect it in Port
---

# Create a Developer Environment

In this example you are going to create a developer environment in AWS then report its information to Port as a developer environment entity.

Our developer environment will include:

- An SQS queue which receives messages;
- A Lambda function that is triggered by messages sent to the queue;
- An S3 bucket that stores the artifacts generated by the S3 function.

:::note Prerequisites
Since we are creating a lambda function, we need to provide its source code. You can download a basic Nodejs Lambda template by clicking [here](https://port-docs-assets.s3.eu-west-1.amazonaws.com/lambda_function_payload.zip) (be sure to save the `.zip` file next to the `main.tf` file)
:::

Here is the complete `main.tf` file:

<details>
<summary>Complete Terraform definition file</summary>

```hcl showLineNumbers
terraform {
  required_providers {
    port-labs = {
      source  = "port-labs/port-labs"
      version = "~> 0.8.1"
    }
  }
}

provider "aws" {
  access_key = "YOUR_ACCESS_KEY_ID"
  secret_key = "YOUR_SECRET_ACCESS_KEY"
  region     = "eu-west-1"
}

provider "port-labs" {
  client_id = "YOUR_CLIENT_ID"     # or set the environment variable PORT_CLIENT_ID
  secret    = "YOUR_CLIENT_SECRET" # or set the environment variable PORT_CLIENT_SECRET
}

resource "aws_s3_bucket" "port_terraform_example_dev_env_bucket" {
  bucket = "my-port-terraform-example-dev-env-bucket"
}

resource "aws_s3_bucket_acl" "port_terraform_example_dev_env_bucket-acl" {
  bucket = aws_s3_bucket.port_terraform_example_dev_env_bucket.id
  acl    = "private"
}

resource "aws_sqs_queue" "port_terraform_example_dev_env_queue" {
  name                        = "terraform-example-queue.fifo"
  fifo_queue                  = true
  content_based_deduplication = true
}

resource "aws_iam_role" "iam_for_lambda" {
  name = "iam_for_lambda"

  assume_role_policy = <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": "sts:AssumeRole",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Effect": "Allow",
      "Sid": ""
    }
  ]
}
EOF
}

resource "aws_iam_role_policy_attachment" "attach_sqs_policy_for_lambda_role" {
  role       = aws_iam_role.iam_for_lambda.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"
}

resource "aws_lambda_function" "port_terraform_example_dev_env_lambda" {
  depends_on = [
    aws_sqs_queue.port_terraform_example_dev_env_queue
  ]

  filename      = "lambda_function_payload.zip"
  function_name = "dev-env-function"
  role          = aws_iam_role.iam_for_lambda.arn
  handler       = "index.test"

  runtime = "nodejs16.x"
}

resource "aws_lambda_function_url" "example_function_url" {
  function_name      = aws_lambda_function.port_terraform_example_dev_env_lambda.function_name
  authorization_type = "NONE"
}

resource "aws_lambda_event_source_mapping" "event_source_mapping" {
  event_source_arn = aws_sqs_queue.port_terraform_example_dev_env_queue.arn
  enabled          = true
  function_name    = aws_lambda_function.port_terraform_example_dev_env_lambda.arn
  batch_size       = 1
}

resource "port-labs_blueprint" "developer_environment" {
  identifier = "developerEnvironment"
  icon       = "Environment"
  title      = "Developer Environment"

  properties {
    identifier = "bucketUrl"
    title      = "Bucket URL"
    required   = false
    type       = "string"
    format     = "url"
  }

  properties {
    identifier = "queueUrl"
    title      = "Queue URL"
    required   = false
    type       = "string"
    format     = "url"
  }

  properties {
    identifier = "lambdaUrl"
    title      = "Lambda URL"
    required   = false
    type       = "string"
    format     = "url"
  }
}


resource "port-labs_entity" "dev_env" {
  depends_on = [
    aws_s3_bucket.port_terraform_example_dev_env_bucket,
    aws_lambda_function.port_terraform_example_dev_env_lambda,
    aws_sqs_queue.port_terraform_example_dev_env_queue,
    aws_lambda_function_url.example_function_url,
    port-labs_blueprint.developer_environment
  ]

  identifier = aws_lambda_function.port_terraform_example_dev_env_lambda.function_name
  title      = aws_lambda_function.port_terraform_example_dev_env_lambda.function_name
  blueprint  = port-labs_blueprint.developer_environment.identifier

  properties {
    name  = "bucketUrl"
    value = "https://${aws_s3_bucket.port_terraform_example_dev_env_bucket.bucket_domain_name}"
  }

  properties {
    name  = "queueUrl"
    value = aws_sqs_queue.port_terraform_example_dev_env_queue.id
  }

  properties {
    name  = "lambdaUrl"
    value = aws_lambda_function_url.example_function_url.function_url
  }
}

```

</details>

To use this example yourself, simply replace the placeholders for `access_key`, `secret_key`, `client_id` and `secret` and then run the following commands to setup your new backend, create the new infrastructure and update the software catalog:

```shell showLineNumbers
# install modules and create an initial state
terraform init
# To view Terraform's planned changes based on your .tf definition file:
terraform plan
# To apply the changes and update the catalog
terraform apply
```

Let's break down the definition file and understand the different parts:

## Module imports

This part includes importing and setting up the required Terraform providers and modules:

```hcl showLineNumbers
terraform {
  required_providers {
    port-labs = {
      source  = "port-labs/port-labs"
      version = "~> 0.8.1"
    }
  }
}

provider "aws" {
  access_key = "YOUR_ACCESS_KEY_ID"
  secret_key = "YOUR_SECRET_ACCESS_KEY"
  region     = "eu-west-1"
}

provider "port-labs" {
  client_id = "YOUR_CLIENT_ID"     # or set the environment variable PORT_CLIENT_ID
  secret    = "YOUR_CLIENT_SECRET" # or set the environment variable PORT_CLIENT_SECRET
}
```

## Defining the AWS resources

This part includes defining the following AWS resources:

- An S3 bucket;
- A SQS FIFO queue;
- An IAM policy for the Lambda function, with access to the new SQS queue;
- A Lambda function with a function URL and event source mapping to the SQS queue.

```hcl showLineNumbers
resource "aws_s3_bucket" "port_terraform_example_dev_env_bucket" {
  bucket = "my-port-terraform-example-dev-env-bucket"
}

resource "aws_s3_bucket_acl" "port_terraform_example_dev_env_bucket-acl" {
  bucket = aws_s3_bucket.port_terraform_example_dev_env_bucket.id
  acl    = "private"
}

resource "aws_sqs_queue" "port_terraform_example_dev_env_queue" {
  name                        = "terraform-example-queue.fifo"
  fifo_queue                  = true
  content_based_deduplication = true
}

resource "aws_iam_role" "iam_for_lambda" {
  name = "iam_for_lambda"

  assume_role_policy = <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": "sts:AssumeRole",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Effect": "Allow",
      "Sid": ""
    }
  ]
}
EOF
}

resource "aws_iam_role_policy_attachment" "attach_sqs_policy_for_lambda_role" {
  role       = aws_iam_role.iam_for_lambda.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"
}

resource "aws_lambda_function" "port_terraform_example_dev_env_lambda" {
  depends_on = [
    aws_sqs_queue.port_terraform_example_dev_env_queue
  ]

  filename      = "lambda_function_payload.zip"
  function_name = "dev-env-function"
  role          = aws_iam_role.iam_for_lambda.arn
  handler       = "index.test"

  runtime = "nodejs16.x"
}

resource "aws_lambda_function_url" "example_function_url" {
  function_name      = aws_lambda_function.port_terraform_example_dev_env_lambda.function_name
  authorization_type = "NONE"
}

resource "aws_lambda_event_source_mapping" "event_source_mapping" {
  event_source_arn = aws_sqs_queue.port_terraform_example_dev_env_queue.arn
  enabled          = true
  function_name    = aws_lambda_function.port_terraform_example_dev_env_lambda.arn
  batch_size       = 1
}
```

## Creating the developer env blueprint and the entity matching the new environment

This part includes configuring the `developerEnvironment` blueprint and creating an entity for our new bucket:

```hcl showLineNumbers
resource "port-labs_blueprint" "developer_environment" {
  identifier = "developerEnvironment"
  icon       = "Environment"
  title      = "Developer Environment"

  properties {
    identifier = "bucketUrl"
    title      = "Bucket URL"
    required   = false
    type       = "string"
    format     = "url"
  }

  properties {
    identifier = "queueUrl"
    title      = "Queue URL"
    required   = false
    type       = "string"
    format     = "url"
  }

  properties {
    identifier = "lambdaUrl"
    title      = "Lambda URL"
    required   = false
    type       = "string"
    format     = "url"
  }
}


resource "port-labs_entity" "dev_env" {
  depends_on = [
    aws_s3_bucket.port_terraform_example_dev_env_bucket,
    aws_lambda_function.port_terraform_example_dev_env_lambda,
    aws_sqs_queue.port_terraform_example_dev_env_queue,
    aws_lambda_function_url.example_function_url,
    port-labs_blueprint.developer_environment
  ]

  identifier = aws_lambda_function.port_terraform_example_dev_env_lambda.function_name
  title      = aws_lambda_function.port_terraform_example_dev_env_lambda.function_name
  blueprint  = port-labs_blueprint.developer_environment.identifier

  properties {
    name  = "bucketUrl"
    value = "https://${aws_s3_bucket.port_terraform_example_dev_env_bucket.bucket_domain_name}"
  }

  properties {
    name  = "queueUrl"
    value = aws_sqs_queue.port_terraform_example_dev_env_queue.id
  }

  properties {
    name  = "lambdaUrl"
    value = aws_lambda_function_url.example_function_url.function_url
  }
}
```

:::info Terraform dependencies
Note how we use a `depends_on` block on the new developer environment entity, this is required because the `developerEnvironment` blueprint has to exist before the entity can be created. In addition, the entity relies on values that will only be available after the AWS resources are created.
:::

## Result

After running `terraform apply` you will see the resources in AWS, and the matching `developerEnvironment` entity in Port.
