# Scaffold a new Repository (Extended Guide)

## Overview
This self-service guide provides a step-by-step walkthrough to scaffold a new repository in GitHub from Port using Port's self-service actions. The self-service action will do the following:
- Create a new repository in GitHub
- Create a corresponding service in PagerDuty


## Prerequisites
1. [Port's GitHub app](https://github.com/apps/getport-io) needs to be installed.
2. In your GitHub repository, [go to **Settings > Secrets**](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository) and add the following secrets:
   - `GH_TOKEN` - GitHub personal access token with `repo` scope.
   - `PAGERDUTY_API_KEY` - [PagerDuty API token](https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account) generated by the user.
   - `PORT_CLIENT_ID` - Your port `client id` [How to get the credentials](https://docs.port.io/build-your-software-catalog/sync-data-to-catalog/api/#find-your-port-credentials).
   - `PORT_CLIENT_SECRET` - Your port `client secret` [How to get the credentials](https://docs.port.io/build-your-software-catalog/sync-data-to-catalog/api/#find-your-port-credentials).
3. Optional - Install Port's [PagerDuty integration](https://docs.port.io/build-your-software-catalog/sync-data-to-catalog/incident-management/pagerduty)

	:::tip PagerDuty Integration
	This step is not required for this example, but it will create all the blueprint boilerplate for you, and also ingest and update the catalog in real time with your PagerDuty Incidents.
	:::

4. Optional - Install Port's [GitHub integration](https://docs.port.io/build-your-software-catalog/sync-data-to-catalog/git/github/)

    :::tip GitHub Integration
    This step is not required for this example, but it will create all the blueprint boilerplate for you, and also ingest and update the catalog in real time with your GitHub repositories.
    :::

4. In case you decide not to install the PagerDuty and GitHub integrations, you will need to create a blueprint for PagerDuty Service and GitHub Repository in Port.

<details>
<summary><b>PagerDuty Service Blueprint (Click to expand)</b></summary>

```json showLineNumbers
{
  "identifier": "pagerdutyService",
  "description": "This blueprint represents a PagerDuty service in our software catalog",
  "title": "PagerDuty Service",
  "icon": "pagerduty",
  "schema": {
    "properties": {
      "status": {
        "title": "Status",
        "type": "string",
        "enum": [
          "active",
          "warning",
          "critical",
          "maintenance",
          "disabled"
        ],
        "enumColors": {
          "active": "green",
          "warning": "yellow",
          "critical": "red",
          "maintenance": "lightGray",
          "disabled": "darkGray"
        }
      },
      "url": {
        "title": "URL",
        "type": "string",
        "format": "url"
      },
      "oncall": {
        "title": "On Call",
        "type": "string",
        "format": "user"
      },
      "escalationLevels": {
        "title": "Escalation Levels",
        "type": "number"
      },
      "meanSecondsToResolve": {
        "title": "Mean Seconds to Resolve",
        "type": "number"
      },
      "meanSecondsToFirstAck": {
        "title": "Mean Seconds to First Acknowledge",
        "type": "number"
      },
      "meanSecondsToEngage": {
        "title": "Mean Seconds to Engage",
        "type": "number"
      },
      "secondaryOncall": {
        "title": "Secondary On Call",
        "type": "string",
        "format": "user"
      }
    },
    "required": []
  },
  "mirrorProperties": {},
  "calculationProperties": {},
  "aggregationProperties": {},
  "relations": {}
}
```

</details>

<details>
<summary><b>GitHub Repository Blueprint (Click to expand)</b></summary>

```json showLineNumbers
{
  "identifier": "service",
  "title": "Service",
  "icon": "Github",
  "schema": {
    "properties": {
      "readme": {
        "title": "README",
        "type": "string",
        "format": "markdown",
        "icon": "Book"
      },
      "url": {
        "title": "URL",
        "format": "url",
        "type": "string",
        "icon": "Link"
      },
      "language": {
        "type": "string",
        "title": "Language",
        "icon": "Git"
      },
      "slack": {
        "icon": "Slack",
        "type": "string",
        "title": "Slack",
        "format": "url"
      },
      "tier": {
        "title": "Tier",
        "type": "string",
        "description": "How mission-critical the service is",
        "enum": [
          "Mission Critical",
          "Customer Facing",
          "Internal Service",
          "Other"
        ],
        "enumColors": {
          "Mission Critical": "turquoise",
          "Customer Facing": "green",
          "Internal Service": "darkGray",
          "Other": "yellow"
        },
        "icon": "DefaultProperty"
      }
    },
    "required": []
  },
  "mirrorProperties": {},
  "calculationProperties": {},
  "aggregationProperties": {},
  "relations": {}
}
```

</details>


## GitHub Workflow
1. Create a new workflow file in your GitHub repository under `.github/workflows` directory. For example, `.github/workflows/scaffold-repository.yml`.

2. Add the following content to the workflow file:

<details>
<summary><b>Scaffold Repository Workflow (Click to expand)</b></summary>

```yaml showLineNumbers
name: Scaffold a repository

on:
  workflow_dispatch:
    inputs:
      name:
        type: string
        required: true
      description:
        type: string
        required: false
      readme:
        type: boolean
        required: false
      visibility:
        type: string
        required: true
      escalation_policy:
        type: string
        required: true
      port_context:
        required: true
        description: includes blueprint, run ID, and entity identifier from Port.
        type: string

jobs:
  scaffold-a-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Inform starting of repository creation
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).run_id }}
          logMessage: |
              Creating GitHub repository... üö®

      - name: Create GitHub repository
        id: create_repo
        run: gh repo create ${{ inputs.name }} --${{ inputs.visibility }} ${{ inputs.description != 'null' && format('--description "{0}"', inputs.description) || ''}} ${{ inputs.readme && '--add-readme' || ''}}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Inform completion of repository creation
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).run_id }}
          logMessage: |
              GitHub repository created üî•

      - name: Inform upsertion of GitHub repo
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).run_id }}
          logMessage: |
              Upserting GitHub repository... üö®
      
      - name: Upsert GitHub repository
        uses: port-labs/port-github-action@v1
        with:
          identifier: "${{ inputs.name }}"
          title: "${{ inputs.name }}"
          icon: github
          blueprint: "${{ fromJson(inputs.port_context).blueprint }}"
          properties: |-
            {
              "readme": "${{ (inputs.readme && inputs.description != 'null') && inputs.description || '' }}"
            }
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          runId: ${{fromJson(inputs.port_context).run_id}}

      - name: Inform completion of upsertion of GitHub repo
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).run_id }}
          logMessage: |
              Upserted GitHub repository successfully! ‚úÖ
      
      - name: Inform starting of PagerDuty Service creation
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).run_id }}
          logMessage: |
              Creating PagerDuty service... üö®

      - name: Create Service in PagerDuty
        id : create_service_request
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://api.pagerduty.com/services'
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json", "Accept": "application/vnd.pagerduty+json;version=2", "Authorization": "Token token=${{ secrets.PAGERDUTY_API_KEY }}"}'
          data: >-
            {
              "service": {
                "name": "${{ inputs.name }}",
                "description": "${{ inputs.description }}",
                "status": "active",
                "escalation_policy": {
                  "id": "${{ inputs.escalation_policy }}",
                  "type": "escalation_policy_reference"
                  }
                }
              }
          
      - name: Log Create Service Request Failure 
        if: steps.create_service_request.outcome == 'failure'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_context).run_id}}
          logMessage: "Request to create PagerDuty Service failed ..."
          
      - name: Log Request Success
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_context).run_id}}
          logMessage: |
              PagerDuty service created! ‚úÖ
              Requesting for on-calls
    
      - name: Request for oncalls for Escalation Policy
        id: fetch_oncalls
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://api.pagerduty.com/oncalls?include[]=users&escalation_policy_ids[]=${{ inputs.escalation_policy }}'
          method: 'GET'
          customHeaders: '{"Content-Type": "application/json", "Accept": "application/json", "Authorization": "Token token=${{ secrets.PAGERDUTY_API_KEY }}"}'

      - name: Extract User Emails
        if: steps.fetch_oncalls.outcome == 'success'
        id: extract_user_emails
        run: |
          echo "Extracting user emails..."
          EMAILS=$(echo '${{ steps.fetch_oncalls.outputs.response }}' | jq -c '[.oncalls[].user.email]')
          echo "Extracted emails: $EMAILS"
          echo "user_emails=${EMAILS}" >> $GITHUB_ENV

      - name: Log Fetch Oncalls Request Failure
        if: steps.fetch_oncalls.outcome == 'failure'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_context).run_id}}
          logMessage: Failed to fetch on-calls ‚ùå
          
      - name: Log Before Upserting Entity
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_context).run_id}}
          logMessage: |
              Upserting Created PagerDuty Entity

      - name: UPSERT PagerDuty Entity
        uses: port-labs/port-github-action@v1
        with:
          identifier: "${{ fromJson(steps.create_service_request.outputs.response).service.id }}" 
          title: "${{ fromJson(steps.create_service_request.outputs.response).service.summary }}"
          icon: pagerduty
          blueprint: "pagerdutyService"
          properties: |-
            {
              "status": "${{ fromJson(steps.create_service_request.outputs.response).service.status }}",
              "url": "${{ fromJson(steps.create_service_request.outputs.response).service.html_url }}",
              "oncall": ${{ env.user_emails }}
            }
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          runId: ${{fromJson(inputs.port_context).run_id}}

      - name: Log After Upserting Entity
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_context).run_id}}
          logMessage: |
              Upserting was successful ‚úÖ

      - name: Inform workflow completion
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).run_id }}
          logMessage: |
              Workflow completed successfully! üöÄ

      - name: Log workflow completion failure
        if: steps.create_repo.outcome == 'failure' || steps.create_service_request.outcome == 'failure'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_context).run_id}}
          logMessage: "Scaffolding repository workflow failed..."
```

</details>


## Port Configuration
1. Create a new self-service action in Port using the following JSON configuration, remember to replace `<GITHUB_ORG>` and `<GITHUB_REPO>` with your GitHub organization and repository name.

<details>
<summary><b>Scaffold a repository (Click to expand)</b></summary>

```json showLineNumbers
{
  "identifier": "scaffold_a_repository_extended",
  "title": "Scaffold a repository (extended)",
  "icon": "Github",
  "description": "Creates a GitHub repository and PagerDuty service pair",
  "trigger": {
    "type": "self-service",
    "operation": "CREATE",
    "userInputs": {
      "properties": {
        "name": {
          "type": "string",
          "title": "Name",
          "description": "Repository name",
          "icon": "Github",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "title": "Description"
        },
        "visibility": {
          "type": "string",
          "title": "Visibility",
          "description": "Internal repositories are only available to enterprise users",
          "default": "Public",
          "enum": [
            "Private",
            "Public",
            "Internal"
          ],
          "enumColors": {
            "Private": "orange",
            "Public": "green",
            "Internal": "lightGray"
          }
        },
        "escalation_policy": {
          "icon": "pagerduty",
          "type": "string",
          "title": "Escalation Policy",
          "description": "PagerDuty service escalation policy ID"
        },
        "readme": {
          "type": "boolean",
          "title": "Readme",
          "default": false,
          "icon": "Github",
          "description": "Whether to add a README"
        }
      },
      "required": [
        "name",
        "visibility",
        "escalation_policy"
      ],
      "order": [
        "name",
        "description",
        "readme",
        "visibility",
        "escalation_policy"
      ]
    },
    "blueprintIdentifier": "service"
  },
  "invocationMethod": {
    "type": "GITHUB",
    // highlight-start
    "org": "<GITHUB_ORG>",
    "repo": "<GITHUB_REPO>",
    // highlight-end
    "workflow": "scaffold-a-repository.yml",
    "workflowInputs": {
      "name": "{{.inputs.name}}",
      "description": "{{.inputs.description}}",
      "readme": "{{.inputs.readme}}",
      "visibility": "{{.inputs.visibility | ascii_downcase}}",
      "escalation_policy": "{{.inputs.escalation_policy}}",
      "port_context": {
        "run_id": "{{ .run.id }}",
        "blueprint": "{{ .action.blueprint }}"
      }
    },
    "reportWorkflowStatus": true
  },
  "requiredApproval": false
}
```

</details>

Now you should see the self-service action in Port's UI.

## Let's test it!
1. Head to the [Self Service page](https://app.getport.io/self-serve)
2. Click on "Create" on the `Scaffold a Repository (Extended)` action.
3. Fill in the required fields and click on `Execute`.
4. Done! You should see a new repository in GitHub and a corresponding service in PagerDuty.

Congratulations! You have successfully scaffolded a new repository in GitHub using Port's self-service actions.

## More Self Service PagerDuty Actions Examples
- [Acknowledge Incident](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/acknowledge-incident)
- [Change On-Call User](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/change-on-call-user)
- [Create PagerDuty incident](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/create-pagerduty-incident)
- [Create PagerDuty service](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/create-pagerduty-service)
- [Escalate an incident](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/escalate-an-incident)
- [Resolve an incident](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/resolve-incident)
- [Trigger PagerDuty incident](https://docs.port.io/actions-and-automations/setup-backend/github-workflow/examples/PagerDuty/trigger-pagerduty-incident)
